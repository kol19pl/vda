name: Create Weekly Release with Changelog

on:
  workflow_dispatch: {}    # ręczne uruchamianie

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # potrzebne do tworzenia release'ów i tagów

    steps:
      # ========================================================
      # 1. Checkout repozytorium z pełną historią commitów
      # ========================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========================================================
      # 2. Pobranie ostatniego tagu
      # ========================================================
      - name: Get last tag
        id: last_tag
        run: |
          LAST_TAG=$(git tag --sort=-creatordate | head -n1 || echo "")
          echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
          echo "Ostatni tag: $LAST_TAG"

      # ========================================================
      # 3. Ustawienie nowego tagu (vYYYY-MM-DD)
      # ========================================================
      - name: Set new tag
        id: new_tag
        run: |
          NEW_TAG=v$(date +'%Y-%m-%d')
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "Nowy tag: $NEW_TAG"

      # ========================================================
      # 4. Wygenerowanie changeloga
      # ========================================================
      - name: Generate Full Changelog
        id: changelog
        run: |
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG=$(git log $LAST_TAG..HEAD --pretty=format:"- %h %s")
          else
            CHANGELOG="Initial release"
          fi

          {
            echo "changelog<<EOF"
            printf '%s\n' "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # ========================================================
      # 5. Utworzenie release i tagu na GitHub
      # ========================================================
      - name: Create new release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: "yt-dlp update ${{ env.NEW_TAG }}"
          body: |
            Automated weekly release created on $(date +'%Y-%m-%d')

            **Full Changelog:**
            ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          allow_updates: true




